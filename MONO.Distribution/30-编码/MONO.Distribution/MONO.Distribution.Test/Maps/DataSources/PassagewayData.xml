<?xml version="1.0" encoding="utf-8" ?>
<sqlMap namespace="Passageway" xmlns="http://ibatis.apache.org/mapping" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">

  <!--实体类映射-->
  <alias>
    <typeAlias alias="Passageway" type="MONO.Distribution.Model.Reports.PassagewayDataModels,MONO.Distribution.Model"/>
  </alias>

  <resultMaps>
    <resultMap id="FB_PassagewayResult" class="Passageway">
      <result property="name" column="name"/>
      <result property="counts" column="counts"/>
    </resultMap>
    <resultMap id="FB_PassagewayUpperStatisticResult" class="Passageway">
      <result property="name" column="name"/>
      <result property="counts" column="counts"/>
      <result property="EnumName" column="name" select="SelectEnumerationByKey" lazyLoad="false"/>
    </resultMap>
    <resultMap id="FB_PassagewayLowerStatisticResult" class="Passageway">
      <result property="key" column="key"/>
      <result property="counts" column="counts"/>
      <result property="SystemUsers" column="key" select="SelectSystemUserByKey" lazyLoad="false"/>
    </resultMap>

  </resultMaps>


  <statements>
    <select id="SelectPassagewayDataByCarrier" parameterClass="Passageway" resultMap="FB_PassagewayResult">
      select isnull(fbi.Name,'') as name,isnull(COUNT(name),0) as counts
      from FD_FlowDistributionRecords fdr
      left join FD_SystemFlowPackets sfp on sfp.SystemFlowPacketKey = fdr.CompanyFlowPacketKey
      left join FD_FlowBaseInfo fbi on fbi.FlowKey = sfp.FlowPacketKey
      where fdr.Carrier =#name# and fdr.OrderStatus = 'CG'
      <isNotEmpty prepend="AND"  property="StartTime">
        <![CDATA[Convert(date, fdr.CreateTime,25)>= Convert(date,convert(datetime,#StartTime#),25)]]>
      </isNotEmpty>
      <isNotEmpty prepend="AND" property="EndTime">
        <![CDATA[Convert(date, fdr.CreateTime,25) <= Convert(date,convert(datetime,#EndTime#)+1,25) ]]>
      </isNotEmpty>
      group by fbi.Name
    </select>

    <select id="SelectUpperStatisticByDate" parameterClass="string" resultMap="FB_PassagewayUpperStatisticResult">
      select isnull(fdr.Carrier,'') as name,isnull(sum(fc.PurchasePrice),0) as counts
      from FD_FlowDistributionRecords fdr
      left join FD_SystemFlowPackets sfp on sfp.SystemFlowPacketKey = fdr.CompanyFlowPacketKey
      left join FD_FlowBaseInfo fbi on fbi.FlowKey = sfp.FlowPacketKey
      inner join FD_FlowCode fc
      on fc.Carrier = fdr.Carrier and fc.ProductCode = fdr.Code    and fbi.FlowKey = fc.FlowKey
      where Convert(nvarchar(20),fdr.CreateTime,120) like '%'+#Value#+'%' and fdr.OrderStatus='CG'
      group by fdr.Carrier
    </select>

    <select id="SelectLowerStatisticByDate" parameterClass="string" resultMap="FB_PassagewayLowerStatisticResult">
      select su.SysUserKey as [key],price as counts
      from (
      select fdr.SysUserKey,  sum(sfp.Price) as price
      from FD_FlowDistributionRecords fdr
      left join FD_SystemFlowPackets sfp on sfp.SystemFlowPacketKey = fdr.CompanyFlowPacketKey
      where OrderStatus = 'CG'  and Convert(nvarchar(20),fdr.CreateTime,120) like '%'+#Value#+'%'
      group by fdr.SysUserKey
      ) t1
      left join FD_System_Users su
      on su.SysUserKey = t1.SysUserKey
    </select>



    <select id="SelectBusinessByMonth" parameterClass="string" resultMap="FB_PassagewayLowerStatisticResult">
       <![CDATA[
      declare @sql varchar(8000)
      declare @mainSql varchar(8000);  
      select @sql = isnull(@sql + '],[' , '') + datt from ( select convert(varchar(10),dateadd(DAY,t2.number,t1.day),120) datt from (select '2017-07'+'-01' day) t1, (select number from MASTER..spt_values WHERE TYPE='P' AND number>=0 and number<=31) t2 where convert(varchar(10),dateadd(DAY,t2.number,t1.day),120) like substring(convert(varchar,GETDATE(),120),1,7)+'%')T1
      set @sql = '[' + @sql + ']'
      set @mainSql = 'select name,datet,  SUM(price) as price  from (select CONVERT(nvarchar(10),CreateTime,120) as datet ,sfp.Price/100 as price,isnull(su.Nick,'''+'测试'+''') as name from FD_FlowDistributionRecords fdr left join FD_SystemFlowPackets sfp on sfp.SystemFlowPacketKey= fdr.CompanyFlowPacketKey left join FD_FlowBaseInfo fbi on fbi.FlowKey = sfp.FlowPacketKey left join FD_System_Users su on su.SysUserKey = fdr.SysUserKey where fbi.Name like '''+'%电信.重庆漫游%'+''' and CONVERT(nvarchar(20),CreateTime,120) like '''+'%2017-07%'+''')T group by name, datet '
      set @sql = 'select * from ('+@mainSql+')tp pivot (max(price) for datet in ('+@sql+'))a'
      exec (@sql)      
      ]]>
    </select>
  </statements>

</sqlMap>
